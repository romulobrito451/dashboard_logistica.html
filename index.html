<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Log√≠stica - Avarias e Performance</title>

    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>

    <script>
// Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyC73PFnSCFomnhKmP6FQ-Drzk1sFIKHOms",
  authDomain: "logistica-dashboard.firebaseapp.com",
  projectId: "logistica-dashboard",
  storageBucket: "logistica-dashboard.firebasestorage.app",
  messagingSenderId: "1057102304003",
  appId: "1:1057102304003:web:1ef8130a0ddb590fb74f36"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
    </script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    
    <style>
        body { background-color: #f8f9fa; }
        .dashboard-card { background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 20px; }
        .form-section { background-color: #e9ecef; border-radius: 8px; padding: 20px; margin-bottom: 30px; }
    </style>
</head>
<body>

<div class="container-fluid p-4">
    <h1 class="mb-4 text-primary">Controle de Log√≠stica: Performance e Sinistros</h1>
    <hr>

    <div class="row">
        <div class="col-md-12">
            <div class="form-section">
                <h3 class="mb-3">‚ûï Inserir Novos Dados (Persist√™ncia Firebase)</h3>
                
            
            <div class="row">
                    <div class="col-md-6 mb-4">
                        <h4 class="text-success">Performance de Entrega</h4>
                        <form id="form-performance">
                            <div class="mb-3"><label class="form-label">M√™s/Ano:</label><input type="text" id="perf-mes" class="form-control" value="06/2025" required></div>
                            <div class="mb-3"><label class="form-label">Entregas no Prazo:</label><input type="number" id="perf-prazo" class="form-control" value="850" required></div>
                            <div class="mb-3"><label class="form-label">Entregas Fora do Prazo:</label><input type="number" id="perf-fora" class="form-control" value="150" required></div>
                            <div class="mb-3"><label class="form-label">Transportadora:</label><input type="text" id="perf-transportadora" class="form-control" value="Transp. Alpha" required></div>
                            <button type="submit" class="btn btn-success w-100">Adicionar Performance</button>
                        </form>
                    </div>

                    <div class="col-md-6 mb-4">
                        <h4 class="text-danger">Avarias e Faltas (Sinistro)</h4>
                        <form id="form-ocorrencia">
                            <div class="mb-3"><label class="form-label">M√™s/Ano:</label><input type="text" id="ocor-mes" class="form-control" value="06/2025" required></div>
                            <div class="mb-3"><label class="form-label">Tipo:</label>
                                <select id="ocor-tipo" class="form-select" required>
                                    <option value="Avaria">Avaria</option>
                                    <option value="Falta">Falta</option>
                                </select>
                            </div>
                            <div class="mb-3"><label class="form-label">Valor Total (Preju√≠zo):</label><input type="number" step="0.01" id="ocor-total" class="form-control" value="500.00" required></div>
                            <div class="mb-3"><label class="form-label">Valor Absorvido:</label><input type="number" step="0.01" id="ocor-absorvido" class="form-control" value="50.00" required></div>
                            <div class="mb-3"><label class="form-label">Valor Recebido (Indeniza√ß√£o):</label><input type="number" step="0.01" id="ocor-recebido" class="form-control" value="400.00" required></div>
                            <div class="mb-3"><label class="form-label">Transportadora:</label><input type="text" id="ocor-transportadora" class="form-control" value="Transp. Beta" required></div>
                            <button type="submit" class="btn btn-danger w-100">Adicionar Ocorr√™ncia</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <h2 class="mt-4 mb-3">üìä Dashboard de Indicadores</h2>

    <div class="row text-center mb-4">
        <div class="col-md-4">
            <div class="dashboard-card bg-light">
                <h4 class="text-success">Entregas no Prazo (OTD)</h4>
                <p class="display-4 text-success" id="kpi-otd">0%</p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="dashboard-card bg-light">
                <h4 class="text-danger">Gap de Indeniza√ß√£o (L√≠quido)</h4>
                <p class="display-4 text-danger" id="kpi-gap">R$ 0.00</p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="dashboard-card bg-light">
                <h4 class="text-primary">Recupera√ß√£o de Sinistro</h4>
                <p class="display-4 text-primary" id="kpi-recuperacao">0%</p>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="dashboard-card">
                <h4 class="text-center">Performance no Prazo por Transportadora</h4>
                <canvas id="chart-performance"></canvas>
            </div>
        </div>

        <div class="col-md-6">
            <div class="dashboard-card">
                <h4 class="text-center">An√°lise Financeira de Sinistro (M√™s)</h4>
                <canvas id="chart-sinistro"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
// --- Fun√ß√µes de Inser√ß√£o (CRUD REAL no Firebase) ---

document.getElementById('form-performance').addEventListener('submit', async function(e) {
    e.preventDefault();
    const newPerf = {
        mes: document.getElementById('perf-mes').value,
        prazo: parseInt(document.getElementById('perf-prazo').value),
        fora: parseInt(document.getElementById('perf-fora').value),
        transp: document.getElementById('perf-transportadora').value,
        timestamp: firebase.firestore.FieldValue.serverTimestamp() // Adiciona data de registro
    };

    try {
        await db.collection('performance').add(newPerf);
        alert(`Performance de ${newPerf.transp} adicionada e salva no Firebase!`);
        updateDashboard(); 
    } catch (error) {
        console.error("Erro ao salvar performance: ", error);
        alert("Erro ao salvar! Verifique as REGRAS e a conex√£o no console.");
    }
});

document.getElementById('form-ocorrencia').addEventListener('submit', async function(e) {
    e.preventDefault();
    const newOcor = {
        mes: document.getElementById('ocor-mes').value,
        tipo: document.getElementById('ocor-tipo').value,
        total: parseFloat(document.getElementById('ocor-total').value),
        absorvido: parseFloat(document.getElementById('ocor-absorvido').value),
        recebido: parseFloat(document.getElementById('ocor-recebido').value),
        transp: document.getElementById('ocor-transportadora').value,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    try {
        await db.collection('ocorrencias').add(newOcor);
        alert(`Ocorr√™ncia de ${newOcor.tipo} adicionada e salva no Firebase!`);
        updateDashboard(); 
    } catch (error) {
        console.error("Erro ao salvar ocorr√™ncia: ", error);
        alert("Erro ao salvar! Verifique as REGRAS e a conex√£o no console.");
    }
});


// --- Fun√ß√µes de Agrega√ß√£o e C√°lculo ---

function aggregatePerformance(performanceData) {
    const perfByTransp = {};
    let totalPrazoGeral = 0;
    let totalEntregasGeral = 0;

    performanceData.forEach(item => {
        const total = item.prazo + item.fora;
        totalPrazoGeral += item.prazo;
        totalEntregasGeral += total;

        if (!perfByTransp[item.transp]) {
            perfByTransp[item.transp] = { prazo: 0, total: 0 };
        }
        perfByTransp[item.transp].prazo += item.prazo;
        perfByTransp[item.transp].total += total;
    });

    const otdGeral = totalEntregasGeral > 0 ? (totalPrazoGeral / totalEntregasGeral) * 100 : 0;
    const labels = Object.keys(perfByTransp);
    const data = labels.map(transp => {
        const item = perfByTransp[transp];
        return ((item.prazo / item.total) * 100).toFixed(2);
    });

    return { otdGeral, labels, data };
}

function aggregateOcorrencia(ocorrenciaData) {
    const sortedOcorrencias = ocorrenciaData.slice().sort((a, b) => {
        return b.mes.localeCompare(a.mes);
    });

    const lastMonth = sortedOcorrencias.length > 0 ? sortedOcorrencias[0].mes : '';

    const lastMonthData = sortedOcorrencias.filter(item => item.mes === lastMonth).reduce((acc, current) => {
        if (!acc.mes) {
            acc.mes = current.mes;
        }
        acc.total += current.total;
        acc.absorvido += current.absorvido;
        acc.recebido += current.recebido;
        return acc;
    }, { mes: '', total: 0, absorvido: 0, recebido: 0 });

    const valorAIndenizar = lastMonthData.total - lastMonthData.absorvido;
    const gapIndenizacao = valorAIndenizar - lastMonthData.recebido;
    const taxaRecuperacao = valorAIndenizar > 0 ? (lastMonthData.recebido / valorAIndenizar) * 100 : 0;
    
    return { lastMonthData, valorAIndenizar, gapIndenizacao, taxaRecuperacao };
}


// --- Fun√ß√µes de Atualiza√ß√£o do Dashboard e BUSCA REAL DE DADOS ---

let chartPerf, chartSinistro; 

async function loadDataAndAggregate() {
    try {
        // BUSCA DADOS DE PERFORMANCE
        const perfSnapshot = await db.collection('performance').get();
        const performanceData = perfSnapshot.docs.map(doc => doc.data());
        
        // BUSCA DADOS DE OCORR√äNCIA
        const ocorSnapshot = await db.collection('ocorrencias').get();
        const ocorrenciaData = ocorSnapshot.docs.map(doc => doc.data());

        // Retorna os dados agregados 
        return {
            perfAgg: aggregatePerformance(performanceData),
            ocorAgg: aggregateOcorrencia(ocorrenciaData),
        };
        
    } catch (error) {
        console.error("Erro ao buscar dados do Firebase: ", error);
        // Retorna dados zerados em caso de falha de conex√£o/regras
        return { perfAgg: { otdGeral: 0, labels: [], data: [] }, ocorAgg: { lastMonthData: { mes: 'N/A' }, gapIndenizacao: 0, taxaRecuperacao: 0 } };
    }
}

async function updateDashboard() { 
    // 1. Busca os dados do Firebase e agrega
    const aggregatedData = await loadDataAndAggregate();
    const { perfAgg, ocorAgg } = aggregatedData;

    // 2. Atualiza√ß√£o dos KPIs
    document.getElementById('kpi-otd').textContent = `${perfAgg.otdGeral.toFixed(1)}%`;
    document.getElementById('kpi-gap').textContent = `R$ ${ocorAgg.gapIndenizacao.toFixed(2).replace('.', ',')}`;
    document.getElementById('kpi-recuperacao').textContent = `${ocorAgg.taxaRecuperacao.toFixed(1)}%`;


    // 3. Atualiza√ß√£o do Gr√°fico de Performance
    if (chartPerf) chartPerf.destroy();
    const ctxPerf = document.getElementById('chart-performance').getContext('2d');
    chartPerf = new Chart(ctxPerf, {
        type: 'bar',
        data: {
            labels: perfAgg.labels,
            datasets: [{
                label: 'OTD %',
                data: perfAgg.data,
                backgroundColor: ['#28a745', '#17a2b8', '#ffc107', '#dc3545'],
                borderColor: 'rgba(0,0,0,0.2)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true, max: 100, title: { display: true, text: 'Percentual (%)' } } }
        }
    });

    // 4. Atualiza√ß√£o do Gr√°fico de Sinistro (Gap Financeiro)
    if (chartSinistro) chartSinistro.destroy();
    const ctxSinistro = document.getElementById('chart-sinistro').getContext('2d');
    chartSinistro = new Chart(ctxSinistro, {
        type: 'bar',
        data: {
            labels: [`Dados Agregados do M√™s: ${ocorAgg.lastMonthData.mes}`],
            datasets: [
                {
                    label: 'Valor Recebido (Indenizado)',
                    data: [ocorAgg.lastMonthData.recebido],
                    backgroundColor: '#28a745'
                },
                {
                    label: 'Valor Absorvido (Custo Interno)',
                    data: [ocorAgg.lastMonthData.absorvido],
                    backgroundColor: '#ffc107'
                },
                {
                    label: 'Gap de Indeniza√ß√£o (Perda L√≠quida)',
                    data: [ocorAgg.gapIndenizacao],
                    backgroundColor: '#dc3545'
                }
            ]
        },
        options: {
            responsive: true,
            scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true, title: { display: true, text: 'Valores (R$)' } } }
        }
    });
}

// Inicializa o Dashboard ao carregar a p√°gina
window.onload = updateDashboard;
</script>

</body>
</html>
                


