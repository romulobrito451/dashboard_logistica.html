<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Log√≠stica - Avarias e Performance</title>

    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>

    <script>
        // Import the functions you need from the SDKs you need
import{ initializeApp }from"firebase/app";   
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "SEU_API_KEY_REAL", 
          authDomain: "SEU_AUTH_DOMAIN",
          projectId: "SEU_PROJECT_ID",
          storageBucket: "SEU_STORAGE_BUCKET",
          messagingSenderId: "SEU_MESSAGING_SENDER_ID",
          appId: "SEU_APP_ID"
        };
        
        // As fun√ß√µes de inicializa√ß√£o precisam ser importadas como m√≥dulos
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(app); // Conecta o banco de dados ao app
    </script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    
    <style>
        body { background-color: #f8f9fa; }
        .dashboard-card { background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 20px; }
        .form-section { background-color: #e9ecef; border-radius: 8px; padding: 20px; margin-bottom: 30px; }
    </style>
</head>
<body>

<div class="container-fluid p-4">
    <h1 class="mb-4 text-primary">Controle de Log√≠stica: Performance e Sinistros</h1>
    <hr>

    <div class="row">
        <div class="col-md-12">
            <div class="form-section">
                <h3 class="mb-3">‚ûï Inserir Novos Dados (Persist√™ncia Firebase)</h3>
                
            
            <div class="row">
                    <div class="col-md-6 mb-4">
                        <h4 class="text-success">Performance de Entrega</h4>
                        <form id="form-performance">
                            <div class="mb-3"><label class="form-label">M√™s/Ano:</label><input type="text" id="perf-mes" class="form-control" value="06/2025" required></div>
                            <div class="mb-3"><label class="form-label">Entregas no Prazo:</label><input type="number" id="perf-prazo" class="form-control" value="850" required></div>
                            <div class="mb-3"><label class="form-label">Entregas Fora do Prazo:</label><input type="number" id="perf-fora" class="form-control" value="150" required></div>
                            <div class="mb-3"><label class="form-label">Transportadora:</label><input type="text" id="perf-transportadora" class="form-control" value="Transp. Alpha" required></div>
                            <button type="submit" class="btn btn-success w-100">Adicionar Performance</button>
                        </form>
                    </div>

                    <div class="col-md-6 mb-4">
                        <h4 class="text-danger">Avarias e Faltas (Sinistro)</h4>
                        <form id="form-ocorrencia">
                            <div class="mb-3"><label class="form-label">M√™s/Ano:</label><input type="text" id="ocor-mes" class="form-control" value="06/2025" required></div>
                            <div class="mb-3"><label class="form-label">Tipo:</label>
                                <select id="ocor-tipo" class="form-select" required>
                                    <option value="Avaria">Avaria</option>
                                    <option value="Falta">Falta</option>
                                </select>
                            </div>
                            <div class="mb-3"><label class="form-label">Valor Total (Preju√≠zo):</label><input type="number" step="0.01" id="ocor-total" class="form-control" value="500.00" required></div>
                            <div class="mb-3"><label class="form-label">Valor Absorvido:</label><input type="number" step="0.01" id="ocor-absorvido" class="form-control" value="50.00" required></div>
                            <div class="mb-3"><label class="form-label">Valor Recebido (Indeniza√ß√£o):</label><input type="number" step="0.01" id="ocor-recebido" class="form-control" value="400.00" required></div>
                            <div class="mb-3"><label class="form-label">Transportadora:</label><input type="text" id="ocor-transportadora" class="form-control" value="Transp. Beta" required></div>
                            <button type="submit" class="btn btn-danger w-100">Adicionar Ocorr√™ncia</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <h2 class="mt-4 mb-3">üìä Dashboard de Indicadores</h2>

    <div class="row text-center mb-4">
        <div class="col-md-4">
            <div class="dashboard-card bg-light">
                <h4 class="text-success">Entregas no Prazo (OTD)</h4>
                <p class="display-4 text-success" id="kpi-otd">0%</p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="dashboard-card bg-light">
                <h4 class="text-danger">Gap de Indeniza√ß√£o (L√≠quido)</h4>
                <p class="display-4 text-danger" id="kpi-gap">R$ 0.00</p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="dashboard-card bg-light">
                <h4 class="text-primary">Recupera√ß√£o de Sinistro</h4>
                <p class="display-4 text-primary" id="kpi-recuperacao">0%</p>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="dashboard-card">
                <h4 class="text-center">Performance no Prazo por Transportadora</h4>
                <canvas id="chart-performance"></canvas>
            </div>
        </div>

        <div class="col-md-6">
            <div class="dashboard-card">
                <h4 class="text-center">Volume de Ocorr√™ncias (Qtd.)</h4>
                <canvas id="chart-volume-ocorrencias"></canvas>
            </div>
        </div>
        
        <div class="col-md-12 mt-4">
            <div class="dashboard-card">
                <h4 class="text-center">An√°lise Financeira de Sinistro (√öltimo M√™s)</h4>
                <canvas id="chart-sinistro"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
// --- Fun√ß√µes de Inser√ß√£o (CRUD) Reescritas para Firebase ---

document.getElementById('form-performance').addEventListener('submit', async function(e) {
    e.preventDefault();
    const newPerf = {
        mes: document.getElementById('perf-mes').value,
        prazo: parseInt(document.getElementById('perf-prazo').value),
        fora: parseInt(document.getElementById('perf-fora').value),
        transp: document.getElementById('perf-transportadora').value,
        // Usando o novo m√©todo para timestamp
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
        await db.collection('performance').add(newPerf);
        alert(`Performance de ${newPerf.transp} adicionada e salva no Firebase!`);
        updateDashboard(); 
    } catch (error) {
        console.error("Erro ao salvar performance: ", error);
        alert("Erro ao salvar! Verifique as REGRAS e o console do Firebase.");
    }
});

document.getElementById('form-ocorrencia').addEventListener('submit', async function(e) {
    e.preventDefault();
    const newOcor = {
        mes: document.getElementById('ocor-mes').value,
        tipo: document.getElementById('ocor-tipo').value,
        total: parseFloat(document.getElementById('ocor-total').value),
        absorvido: parseFloat(document.getElementById('ocor-absorvido').value),
        recebido: parseFloat(document.getElementById('ocor-recebido').value),
        transp: document.getElementById('ocor-transportadora').value,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    try {
        await db.collection('ocorrencias').add(newOcor);
        alert(`Ocorr√™ncia de ${newOcor.tipo} adicionada e salva no Firebase!`);
        updateDashboard(); 
    } catch (error) {
        console.error("Erro ao salvar ocorr√™ncia: ", error);
        alert("Erro ao salvar! Verifique as REGRAS e o console do Firebase.");
    }
});


// --- Fun√ß√µes de Agrega√ß√£o e C√°lculo ---

function aggregatePerformance(performanceData) {
    const perfByTransp = {};
    let totalPrazoGeral = 0;
    let totalEntregasGeral = 0;

    performanceData.forEach(item => {
        const total = item.prazo + item.fora;
        totalPrazoGeral += item.prazo;
        totalEntregasGeral += total;

        if (!perfByTransp[item.transp]) {
            perfByTransp[item.transp] = { prazo: 0, total: 0 };
        }
        perfByTransp[item.transp].prazo += item.prazo;
        perfByTransp[item.transp].total += total;
    });

    const otdGeral = totalEntregasGeral > 0 ? (totalPrazoGeral / totalEntregasGeral) * 100 : 0;
    const labels = Object.keys(perfByTransp);
    const data = labels.map(transp => {
        const item = perfByTransp[transp];
        return ((item.prazo / item.total) * 100).toFixed(2);
    });

    return { otdGeral, labels, data };
}

function aggregateOcorrencia(ocorrenciaData) {
    const sortedOcorrencias = ocorrenciaData.slice().sort((a, b) => {
        const [mA, aA] = a.mes.split('/').map(Number);
        const [mB, aB] = b.mes.split('/').map(Number);
        return (aB * 100 + mB) - (aA * 100 + mA);
    });

    const lastMonth = sortedOcorrencias.length > 0 ? sortedOcorrencias[0].mes : '';

    const lastMonthData = sortedOcorrencias.filter(item => item.mes === lastMonth).reduce((acc, current) => {
        if (!acc.mes || current.mes === acc.mes) {
            acc.mes = current.mes;
            acc.total += current.total;
            acc.absorvido += current.absorvido;
            acc.recebido += current.recebido;
        }
        return acc;
    }, { mes: '', total: 0, absorvido: 0, recebido: 0 });

    const valorAIndenizar = lastMonthData.total - lastMonthData.absorvido;
    const gapIndenizacao = valorAIndenizar - lastMonthData.recebido;
    const taxaRecuperacao = valorAIndenizar > 0 ? (lastMonthData.recebido / valorAIndenizar) * 100 : 0;
    
    return { lastMonthData, valorAIndenizar, gapIndenizacao, taxaRecuperacao };
}

function aggregateVolumeOcorrencia(ocorrenciaData) {
    const volumeByMonth = {};
    
    ocorrenciaData.forEach(item => {
        if (!volumeByMonth[item.mes]) {
            volumeByMonth[item.mes] = { Avaria: 0, Falta: 0 };
        }
        volumeByMonth[item.mes][item.tipo] += 1;
    });

    const sortedMonths = Object.keys(volumeByMonth).sort((a, b) => {
        const [mA, aA] = a.split('/').map(Number);
        const [mB, aB] = b.split('/').map(Number);
        return (aA * 100 + mA) - (aB * 100 + mB);
    });

    const avariasData = sortedMonths.map(mes => volumeByMonth[mes].Avaria);
    const faltasData = sortedMonths.map(mes => volumeByMonth[mes].Falta);

    return { labels: sortedMonths, avarias: avariasData, faltas: faltasData };
}


// --- Fun√ß√µes de Atualiza√ß√£o do Dashboard e Busca de Dados ---

let chartPerf, chartSinistro, chartVolumeOcorrencias; 

async function loadDataAndAggregate() {
    try {
        // BUSCA DADOS DE PERFORMANCE
        const perfSnapshot = await db.collection('performance').get();
        const performanceData = perfSnapshot.docs.map(doc => doc.data());
        
        // BUSCA DADOS DE OCORR√äNCIA
        const ocorSnapshot = await db.collection('ocorrencias').get();
        const ocorrenciaData = ocorSnapshot.docs.map(doc => doc.data());

        // Retorna os dados agregados 
        return {
            perfAgg: aggregatePerformance(performanceData),
            ocorAgg: aggregateOcorrencia(ocorrenciaData),
            volumeAgg: aggregateVolumeOcorrencia(ocorrenciaData)
        };
        
    } catch (error) {
        console.error("Erro ao buscar dados do Firebase: ", error);
        // O erro no console mostrar√° se √© falha de conex√£o (chave) ou de seguran√ßa (regras)
        return { perfAgg: { otdGeral: 0, labels: [], data: [] }, ocorAgg: { lastMonthData: { mes: 'N/A' }, gapIndenizacao: 0, taxaRecuperacao: 0 }, volumeAgg: { labels: [], avarias: [], faltas: [] } };
    }
}

async function updateDashboard() { 
    // 1. Busca os dados do Firebase e agrega
    const aggregatedData = await loadDataAndAggregate();
    const { perfAgg, ocorAgg, volumeAgg } = aggregatedData;

    if (!perfAgg.labels) return; 

    // 2. Atualiza√ß√£o dos KPIs
    document.getElementById('kpi-otd').textContent = `${perfAgg.otdGeral.toFixed(1)}%`;
    document.getElementById('kpi-gap').textContent = `R$ ${ocorAgg.gapIndenizacao.toFixed(2).replace('.', ',')}`;
    document.getElementById('kpi-recuperacao').textContent = `${ocorAgg.taxaRecuperacao.toFixed(1)}%`;


    // 3. Atualiza√ß√£o do Gr√°fico de Sinistro (Gap Financeiro)
    if (chartSinistro) chartSinistro.destroy();
    const ctxSinistro = document.getElementById('chart-sinistro').getContext('2d');
    chartSinistro = new Chart(ctxSinistro, {
        type: 'bar',
        data: {
            labels: [`Dados Agregados do M√™s: ${ocorAgg.lastMonthData.mes}`],
            datasets: [
                {
                    label: 'Valor Recebido (Indenizado)',
                    data: [ocorAgg.lastMonthData.recebido],
                    backgroundColor: '#28a745'
                },
                {
                    label: 'Valor Absorvido (Custo Interno)',
                    data: [ocorAgg.lastMonthData.absorvido],
                    backgroundColor: '#ffc107'
                },
                {
                    label: 'Gap de Indeniza√ß√£o (Perda L√≠quida)',
                    data: [ocorAgg.gapIndenizacao],
                    backgroundColor: '#dc3545'
                }
            ]
        },
        options: {
            responsive: true,
            scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true, title: { display: true, text: 'Valores (R$)' } } }
        }
    });

    // 4. Gr√°fico de Volume de Ocorr√™ncias (Linhas)
    if (chartVolumeOcorrencias) chartVolumeOcorrencias.destroy();
    const ctxVolumeOcorrencias = document.getElementById('chart-volume-ocorrencias').getContext('2d');
    chartVolumeOcorrencias = new Chart(ctxVolumeOcorrencias, {
        type: 'line',
        data: {
            labels: volumeAgg.labels,
            datasets: [
                {
                    label: 'Avarias (Qtd.)',
                    data: volumeAgg.avarias,
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    tension: 0.3
                },
                {
                    label: 'Faltas (Qtd.)',
                    data: volumeAgg.faltas,
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    tension: 0.3
                }
            ]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true, title: { display: true, text: 'Quantidade de Ocorr√™ncias' } } }
        }
    });
    
    // 5. Atualiza√ß√£o do Gr√°fico de Performance
    if (chartPerf) chartPerf.destroy();
    const ctxPerf = document.getElementById('chart-performance').getContext('2d');
    chartPerf = new Chart(ctxPerf, {
        type: 'bar',
        data: {
            labels: perfAgg.labels,
            datasets: [{
                label: 'OTD %',
                data: perfAgg.data,
                backgroundColor: ['#28a745', '#17a2b8', '#ffc107', '#dc3545'],
                borderColor: 'rgba(0,0,0,0.2)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true, max: 100, title: { display: true, text: 'Percentual (%)' } } }
        }
    });
}

// Inicializa o Dashboard ao carregar a p√°gina
window.onload = updateDashboard;
</script>

</body>
</html>

